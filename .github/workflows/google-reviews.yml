name: Update Google Reviews JSON

on:
  workflow_dispatch:
  schedule:
    - cron: "17 */6 * * *"   # every 6 hours

permissions:
  contents: write

concurrency:
  group: google-reviews-json
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch Google Place details (rating, count, reviews)
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          PLACE_ID: "ChIJTYmk-ipFXS8RUd3znZzyANA"
        run: |
          set -e
          mkdir -p data

          curl -sS \
            -H "X-Goog-Api-Key: ${GOOGLE_API_KEY}" \
            -H "X-Goog-FieldMask: rating,userRatingCount,reviews" \
            "https://places.googleapis.com/v1/places/${PLACE_ID}" \
            > /tmp/place.json

          node <<'NODE'
          const fs = require("fs");

          const raw = JSON.parse(fs.readFileSync("/tmp/place.json","utf8"));
          const out = {
            rating: typeof raw.rating === "number" ? raw.rating : 0,
            userRatingCount: typeof raw.userRatingCount === "number" ? raw.userRatingCount : 0,
            updatedAt: new Date().toLocaleString("en-GB", { timeZone: "Europe/London" }),
            reviews: []
          };

          const reviews = Array.isArray(raw.reviews) ? raw.reviews : [];
          out.reviews = reviews.slice(0, 12).map(r => ({
            authorName: (r && r.authorAttribution && r.authorAttribution.displayName) ? r.authorAttribution.displayName : "Google customer",
            relativeTime: r && r.relativePublishTimeDescription ? r.relativePublishTimeDescription : "",
            rating: (r && typeof r.rating === "number") ? r.rating : 5,
            text: (r && r.text && r.text.text) ? r.text.text : ""
          })).filter(r => r.text);

          fs.writeFileSync("data/google-reviews.json", JSON.stringify(out, null, 2));
          console.log("Wrote data/google-reviews.json");
          NODE

      - name: Commit and push (with pull --rebase)
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data/google-reviews.json

          # Nothing to commit? Stop cleanly.
          git diff --cached --quiet && echo "No changes." && exit 0

          git commit -m "Update Google reviews JSON"

          # Sync with remote first, then push
          git pull --rebase origin main
          git push origin main
