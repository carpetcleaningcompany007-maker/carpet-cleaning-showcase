<script>
/* =============================
   CONFIG
============================= */

const EXTRAS = {
  scotchgard: 15,   // HALF PRICE
  deodorise: 10,
  insecticide: 20
};

const ITEMS = {
  carpets: [
    { id:"staircase",name:"Staircase",desc:"Per flight",price:42 },
    { id:"hallway",name:"Hallway",desc:"Downstairs corridor",price:22 },
    { id:"landing",name:"Landing",desc:"Upstairs passage",price:22 },
    { id:"living",name:"Living Room",desc:"Family room",price:79 },
    { id:"bedroom",name:"Bedroom",desc:"Regular or large",price:37 },
    { id:"dining",name:"Dining Room",desc:"Or breakfast room",price:57 },
    { id:"bathroom",name:"Bathroom",desc:"Or shower room",price:22 },
    { id:"boxroom",name:"Box Room",desc:"Box bedroom or study",price:27 },
    { id:"study",name:"Study",desc:"Office or spare room",price:27 },
    { id:"loungediner",name:"Lounge Diner",desc:"Joined through room",price:99 }
  ],
  rugs:[
    { id:"rug_small",name:"Rug Small",desc:"Steam clean",price:25 },
    { id:"rug_medium",name:"Rug Medium",desc:"Steam clean",price:35 },
    { id:"rug_large",name:"Rug Large",desc:"Steam clean",price:49 }
  ],
  upholstery:[
    { id:"sofa2",name:"2 Seat Sofa",desc:"Fabric or leather",price:65 },
    { id:"sofa3",name:"3 Seat Sofa",desc:"Fabric or leather",price:85 },
    { id:"corner",name:"Corner Sofa",desc:"Standard size",price:120 },
    { id:"armchair",name:"Armchair",desc:"Single seat",price:45 }
  ]
};

/* =============================
   STATE
============================= */

const state = {
  qty:{},
  extras:{ scotchgard:false,deodorise:false,insecticide:false }
};

/* =============================
   HELPERS
============================= */

const fmt=n=>"£"+n.toFixed(2);

function totalItems(){
  return Object.values(state.qty).reduce((a,b)=>a+b,0);
}

/* =============================
   CALCULATOR (FIXED)
============================= */

function calculate(){

  let subtotal=0;
  let breakdown=[];

  const all=[...ITEMS.carpets,...ITEMS.rugs,...ITEMS.upholstery];

  all.forEach(it=>{
    let q=state.qty[it.id]||0;
    if(!q) return;

    let line=q*it.price;
    subtotal+=line;

    breakdown.push({name:it.name,qty:q,unit:it.price,total:line});
  });

  /* extras per selected item */
  let itemsCount=totalItems();
  let extrasTotal=0;

  Object.entries(state.extras).forEach(([key,on])=>{
    if(!on||!itemsCount) return;

    let price=EXTRAS[key];
    let line=price*itemsCount;
    extrasTotal+=line;

    breakdown.push({
      name:key.charAt(0).toUpperCase()+key.slice(1),
      qty:itemsCount,
      unit:price,
      total:line
    });
  });

  let grand=subtotal+extrasTotal;

  return{grand,breakdown};
}

/* =============================
   RENDER
============================= */

function render(){

  const r=calculate();
  document.getElementById("total").textContent=fmt(r.grand);

  const list=document.getElementById("selectedList");
  const empty=document.getElementById("emptyState");

  if(!r.breakdown.length){
    list.innerHTML="";
    list.appendChild(empty);
    empty.style.display="block";
  }
  else{
    empty.style.display="none";
    list.innerHTML=r.breakdown.map(x=>`
      <div class="line">
        <div>
          <b>${x.name}</b>
          <small>${x.qty} × ${fmt(x.unit)}</small>
        </div>
        <div class="money">${fmt(x.total)}</div>
      </div>
    `).join("")+
    `<div class="hr"></div>
     <div class="line">
       <b>Total</b>
       <div class="money">${fmt(r.grand)}</div>
     </div>`;
  }

  document.getElementById("breakdown").value=r.breakdown.map(x=>`${x.name} ${x.qty}x`).join(", ");
  document.getElementById("totalHidden").value=fmt(r.grand);
}

/* =============================
   BUTTONS
============================= */

document.querySelectorAll(".items").forEach(group=>{
  group.addEventListener("click",e=>{
    const btn=e.target.closest(".qbtn");
    if(!btn) return;

    const card=e.target.closest(".item");
    const id=card.dataset.id;

    let q=state.qty[id]||0;
    if(btn.dataset.act==="inc") q++;
    else q=Math.max(0,q-1);

    state.qty[id]=q;
    card.querySelector(".qnum").textContent=q;

    render();
  });
});

/* extras toggles */
document.getElementById("x_scotch").onchange=e=>{state.extras.scotchgard=e.target.checked;render();}
document.getElementById("x_deo").onchange=e=>{state.extras.deodorise=e.target.checked;render();}
document.getElementById("x_insect").onchange=e=>{state.extras.insecticide=e.target.checked;render();}

render();

/* submit demo */
function handleSubmit(e){
 e.preventDefault();
 alert("Form captured. Connect Formspree later.");
 return false;
}
window.handleSubmit=handleSubmit;
</script>
